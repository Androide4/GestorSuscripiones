{% extends 'base.html' %}
{% block title %}Mis Suscripciones{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Mis Suscripciones</h2>
    <a href="{% url 'suscripciones:create' %}" class="btn btn-primary btn-lg">+ Añadir Suscripción</a>
</div>

<!-- Stats -->
<div class="row g-4 mb-5">
    <div class="col-md-3">
        <div class="stats-card">
            <p class="text-muted mb-1">Gasto Mensual</p>
            <h3 class="text-primary">${{ monthly_spend|floatformat:2 }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="

stats-card">
            <p class="text-muted mb-1">Gasto Anual</p>
            <h3 class="text-success">${{ yearly_spend|floatformat:2 }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <p class="text-muted mb-1">Activas</p>
            <h3 class="text-info">{{ active_subs }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <p class="text-muted mb-1">Próximos Pagos</p>
            <h3 class="text-warning">{{ upcoming }}</h3>
        </div>
    </div>
</div>

<!-- Suscripciones -->
<div class="row g-4">
    {% for sub in suscripciones %}
    <div class="col-12">
        <div class="sub-card p-4">
            <div class="row align-items-center">
                <!-- LADO IZQUIERDO: Calificación + Botones -->
                <div class="col-md-4 text-center text-md-start">
                    <div class="rating fs-1 fw-bold text-warning mb-3">
                        ★ {{ sub.avg_puntuacion|default:"–" }}
                    </div>
                    <div class="d-grid gap-2 d-md-block">
                        <a href="{% url 'calificaciones:create' suscripcion_pk=sub.pk %}" 
                           class="btn btn-outline-primary btn-sm me-md-2 mb-2">Calificar</a>
                        <a href="{% url 'calificaciones:list' suscripcion_pk=sub.pk %}" 
                           class="btn btn-outline-secondary btn-sm me-md-2 mb-2">Ver Calificaciones</a>
                        <a href="{% url 'suscripciones:update' sub.pk %}" 
                           class="btn btn-warning btn-sm me-md-2 mb-2">Editar</a>
                        <a href="{% url 'suscripciones:delete' sub.pk %}" 
                           class="btn btn-danger btn-sm mb-2">Eliminar</a>
                    </div>
                </div>

                <!-- LADO DERECHO: Información de la suscripción -->
                <div class="col-md-8">
                    <div class="d-flex align-items-center mb-3">
                        <div class="sub-logo me-3">{{ sub.proveedor.nombre|first|upper }}</div>
                        <div>
                            <h4 class="mb-0">{{ sub.proveedor.nombre }}</h4>
                            <small class="text-muted">
                                {% if sub.plan %}
                                    {{ sub.plan.nombre }}
                                {% else %}
                                    Suscripción personalizada
                                {% endif %}
                            </small>
                        </div>
                    </div>

                    {% if sub.descripcion %}
                        <p class="text-muted mb-2">{{ sub.descripcion }}</p>
                    {% endif %}

                    <div class="row text-md-end">
                        <div class="col-md-6">
                            <p class="mb-1">
                                <strong class="fs-4 text-primary">
                                    {% if sub.plan %}
                                        ${{ sub.plan.precio }} {{ sub.plan.moneda.simbolo }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </strong>
                                <small class="text-muted">/ mes</small>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-0 text-muted">
                                Próximo pago: <strong>{{ sub.fecha_fin|date:"d/m/Y" }}</strong><br>
                                <small>{{ sub.fecha_fin|timeuntil }} restantes</small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12 text-center py-5">
        <p class="text-muted fs-4">No tienes suscripciones aún</p>
        <a href="{% url 'suscripciones:create' %}" class="btn btn-primary btn-lg">Añadir mi primera suscripción</a>
    </div>
    {% endfor %}
</div>
{% endblock %}